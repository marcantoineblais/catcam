# Image from GitHub Actions: ghcr.io/<your-github-username-or-org>/catcam:latest
# Set CATCAM_IMAGE in stack.env when using the CI-built image (see README).
# All app env vars (DOMAIN_NAME, SERVER_URL, etc.) come from env_file: stack.env.
# Do not re-list them in environment: or Compose substitutes from the host and can overwrite with empty.
services:
  catcam:
    image: ${CATCAM_IMAGE:-catcam:latest}
    container_name: catcam
    env_file: stack.env
    restart: unless-stopped
    volumes:
      - user-settings:${USER_SETTINGS_PATH:-/data/user-settings}
    networks:
      - private
      - caddy_proxy
  db:
    image: mariadb:10.6
    container_name: shinobi-db
    restart: unless-stopped
    env_file: stack.env
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-shinobi_root}
      MYSQL_DATABASE: ${DB_DATABASE:-ccio}
      MYSQL_USER: ${DB_USER:-shinobi}
      MYSQL_PASSWORD: ${DB_PASSWORD:-shinobi_pass}
    volumes:
      - shinobi_db:/var/lib/mysql
    networks:
      - private
  shinobi:
    image: registry.gitlab.com/shinobi-systems/shinobi:dev
    container_name: shinobi
    restart: unless-stopped
    depends_on:
      - db
    env_file: stack.env
    ports:
      - "${SHINOBI_PORT:-8080}:8080"
    volumes:
      - shinobi_config:/config
      - shinobi_videos:/home/Shinobi/videos
      - shinobi_plugin:/home/Shinobi/plugins
      - /dev/shm/Shinobi/streams:/dev/shm/streams
      - /mnt/catcam_videos:/mnt/cloud
    networks:
      - private
      - caddy_proxy

volumes:
  user-settings:
  shinobi_db:
  shinobi_config:
  shinobi_videos:
  shinobi_plugin:

networks:
  private:
    driver: bridge
  caddy_proxy:
    external: true